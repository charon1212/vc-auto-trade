# ログ設計

本書では、本システムにおけるログの基本方針を記載する。
(初めてのログ設計なので、多少はぼろがあってもご容赦ください…)

## ログ出力の共通化

ログ出力は、[log.ts](../../lib/lambda/Common/log.ts)で定めるappLoggerを利用する。ここでログ出力に関する共通仕様を定義する。共通仕様の詳細は、実装のドキュメントコメントに残す。

## ログレベル

ログレベルは次の5段階を採用する。

- error: 本システムの本来の処理を続行できないような致命的な事象に用いる。
- warn: 本システムの本来の処理は実行できるが、望ましくない事象が発生した場合に用いる。
- info: 本設計書の後述する設計に基づき、処理の大まかな流れを追いかけるために必要な情報に用いる。infoログは、運用費用の都合により、次の3レベルに分かれる。
  - info1: 重要なInfoログのうち、出力ログの平均的なデータサイズが小さいものに使う。目安として、10を超えるオブジェクトの配列のJSON文字列を出力するような場合はinfo2を使う。
  - info2: 重要なInfoログのうち、出力ログの平均的なデータサイズが大きいものに使う。
  - info3: そこまで重要ではInfoログ。例えば、同時刻の前後のログと比較することで、前後のログに意味を持たせるためのログ（関数の開始・終了等）。
- debug: デバッグ用に一時的に導入するログ出力に用いる。
- trace: 基本的に使わない。様々な機能から使われる共通機能(APIリクエスト部分など)に対して、その処理をトレースする際に一時的に利用する。

## infoログ

Infoログは各フェーズごとに、次の規則でinfoログを出力する。

### Interfaces/AWS

次のタイミングでログを出力する。

| タイミング | Infoレベル | 接頭辞 | 内容 |
|:--|:--|:--|:--|
| AWSリソースへの関数を呼び出した時 | 3 | `▲▲<ProductId>-AWS-<リソース名>-<関数名>-CALL-` | 引数 |
| AWSリソースから何らかの戻り値を取得した時 | 3 | `▲▲<ProductId>-AWS-<リソース名>-<関数名>-RESULT-` | 戻り値の内容 |

### Interfaces/ExchangeApi

次のタイミングでログを出力する。

| タイミング | Infoレベル | 接頭辞 | 内容 |
|:--|:--|:--|:--|
| 第1階層の関数を呼び出した時 | 2 | `★★<ProductId>-API-<関数名>-CALL-` | 引数 |
| 第1階層の関数を呼び出した時 | 2 | `★★<ProductId>-API-<関数名>-RESULT-` | 戻り値 |
| APIリクエスト送信時 | 2 | `★★API-REQUEST-` | 引数、リクエストのURL・メソッド・ヘッダー・ボディ |
| APIから200レスポンスを取得した場合 | 2 | `★★API-RESPONSE-` | リクエストURL、レスポンス |

※第1階層関数は、ExchangeApiフォルダ直下の関数で、Interfaces/ExchangeApi以外のモジュールから呼ばれる関数を指す。

### Main

次のタイミングでログを出力する。

| タイミング | Infoレベル | 接頭辞 | 内容 |
|:--|:--|:--|:--|
| 入力フェーズ開始時 | 3 | `○〇<ProductId>-PhaseInput-Start-` | プロダクトコンテキスト |
| 入力フェーズ終了時 | 3 | `〇〇<ProductId>-PhaseInput-End-` | 入力フェーズで取得したデータ |
| 処理フェーズ開始時 | 3 | `○〇<ProductId>-PhaseExec-Start` | なし |
| 処理フェーズ終了時 | 3 | `〇〇<ProductId>-PhaseExec-End-` | 処理フェーズの戻り値 |
| 保存フェーズ開始時 | 3 | `○〇<ProductId>-PhaseOutput-Start` | なし |
| 保存フェーズ終了時 | 3 | `○〇<ProductId>-PhaseOutput-End-` | プロダクトコンテキスト |
| 発注中（約定待ち）の時 | 1 | `○○〇<ProductId>-TargetOrder-` | 発注オーダーの内容 |
| 注文状態が遷移した時 | 1 | `○○〇<ProductId>-ChangePhase-<BeforePhase>→<AfterPhase>` | なし |
| 買い・売り・損切の判断をしたとき | 1 | `〇〇〇<ProductId>-Judge-` | 買い・売り・損切のいずれの判断をしたか、判断の理由となる指標等 |
